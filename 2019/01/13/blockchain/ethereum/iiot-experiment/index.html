<!DOCTYPE html>
<html lang="en">

<!-- Head tag -->
<head><meta name="generator" content="Hexo 3.8.0">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="关于后台设计、音游与设计 | 陈志凌，Web &amp; Cloud Computing，Software Engineer | 这里是 @banban 陈志凌 的个人博客，与你一起发现更大的世界。">
    <meta name="keyword" content="陈志凌, banbanpeppa陈志凌, banbanpeppa, peppa, @banbanpeppa, 陈志凌的博客, banbanpeppa Blog, 博客, 个人网站, 互联网, Web, Cloud, Kubernetes, OpenStack, Docker, Kubeflow">
    <link rel="shortcut icon" href="/images/favicon.png">
    <!-- Place this tag in your head or just before your close body tag. -->
    <script async defer src="https://buttons.github.io/buttons.js"></script>
    <title>
        
          使用以太坊进行IIOT实验 - banban&#39;s Blog
        
    </title>

    <link rel="canonical" href="https://banbanpeppa.github.io/2019/01/13/blockchain/ethereum/iiot-experiment/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css">

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css">

    <link rel="stylesheet" href="/css/widget.css">

    <link rel="stylesheet" href="/css/rocket.css">

    <link rel="stylesheet" href="/css/signature.css">

    <link rel="stylesheet" href="/css/toc.css">

    <!-- Custom Fonts -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- Hux Delete, sad but pending in China
    <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/
    css'>
    -->


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">
	<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->
<style type="text/css">
    header.intro-header{
        
            background-image: url('/images/blockchain/ethereum/bg.jpg')
            /*post*/
        
    }
    
</style>

<header class="intro-header">
    <!-- Signature -->
    <div id="signature">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                
                    <div class="post-heading">
                        <div class="tags">
                            
                              <a class="tag" href="/tags/#Blockchain" title="Blockchain">Blockchain</a>
                            
                              <a class="tag" href="/tags/#Ethereum" title="Ethereum">Ethereum</a>
                            
                        </div>
                        <h1>使用以太坊进行IIOT实验</h1>
                        <h2 class="subheading"></h2>
                        <span class="meta">
                            Posted by banban on
                            2019-01-13
                        </span>
                    </div>
                


                </div>
            </div>
        </div>
    </div>
</header>


    <!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
    <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">banban&#39;s Blog</a>
        </div>

        <!-- Collect the nav links, forms, and other content for toggling -->
        <!-- Known Issue, found by Hux:
            <nav>'s height woule be hold on by its content.
            so, when navbar scale out, the <nav> will cover tags.
            also mask any touch event of tags, unfortunately.
        -->
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">Home</a>
                    </li>

                    

                        
                    

                        
                        <li>
                            <a href="/about/">About Me</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/archive/">Archives</a>
                        </li>
                        
                    

                        
                        <li>
                            <a href="/tags/">Tags</a>
                        </li>
                        
                    

                        
                    

                        
                    

                        
                    

                </ul>
            </div>
        </div>
        <!-- /.navbar-collapse -->
    </div>
    <!-- /.container -->
</nav>
<script>
    // Drop Bootstarp low-performance Navbar
    // Use customize navbar with high-quality material design animation
    // in high-perf jank-free CSS3 implementation
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        // CLOSE
            $navbar.className = " ";
            // wait until animation end.
            setTimeout(function(){
                // prevent frequently toggle
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        // OPEN
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>


    <!-- Main Content -->
    <!-- Modify by Yu-Hsuan Yen -->

<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

            <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <h1 id="使用以太坊进行IIOT实验"><a href="#使用以太坊进行IIOT实验" class="headerlink" title="使用以太坊进行IIOT实验"></a>使用以太坊进行IIOT实验</h1><h2 id="编写智能合约"><a href="#编写智能合约" class="headerlink" title="编写智能合约"></a>编写智能合约</h2><p>合约<code>Iiot.sol</code>内容如下</p>
<pre><code>//由于需要开启返回数组类型，因此需要开启这个实验环境下的环境
pragma experimental ABIEncoderV2;
//编译器版本需要是0.4.25+commit.59dbf8f1
pragma solidity &gt;=0.4.22 &lt;0.6.0;

//本合约用于工业物联网中实现访问控制及其数据读写控制
contract Iiot {

    struct Node {
        string id;
        string ip;
        string name;
        string area;
        string _type;
        string nodeType;
        string productType;
        uint8 productAmount;
        string status;
        bytes delegatorSignature;
        address delegator;
    }

    //各种节点类型
    string TYPE_SUPPLIER = &quot;supplier&quot;;
    string TYPE_MANUFACTURER = &quot;manufacturer&quot;;
    string TYPE_COVEYANCE = &quot;conveyance&quot;;
    string TYPE_RETAIL = &quot;retail&quot;;

    mapping (address =&gt; Node) enrolled_nodes;
    mapping (string =&gt; address) used;
    mapping (address =&gt; string[]) info_lists;
    mapping (address =&gt; string) policy_storage;

    string[] infos = new string[](1);
    address admin;

    constructor() public {
      admin = msg.sender;
      make_node(admin, &quot;CH0&quot;, &quot;0.0.0.0&quot;, &quot;admin&quot;, &quot;*&quot;, &quot;admin&quot;, &quot;*&quot;, &quot;none&quot;, 0, &quot;active&quot;, &quot;none&quot;, admin);
    }

    //登记节点，登记的时候需要提交签名和所签名的内容hash，在校验通过之后才会登记成功，并将成功的节点添加到storage中
    function enroll_manager_node(string memory id, string memory ip, string memory name, string memory area,
       string memory _type, string memory nodeType, string memory productType, uint8 productAmount,
       bytes memory signature, bytes32 hash, address delegator) public returns(bool, string memory) {
      address enroll_node = msg.sender;
      //判断属性内容是否都不为空
      //判断id是否已经存在，name是否存在， 判断ip地址是否存在
      if(check_str_equal(id, &quot;&quot;) || check_str_equal(ip, &quot;&quot;) || check_str_equal(name, &quot;&quot;) ||
        check_str_equal(area, &quot;&quot;) || check_str_equal(_type, &quot;&quot;) || check_str_equal(nodeType, &quot;&quot;)) {
        return (false, &quot;parameters empty error&quot;);
      }

      if (used[name] != address(0x0)) {
        return (false, &quot;name is used&quot;);
      }
      if (used[ip] != address(0x0)) {
        return (false, &quot;ip is used&quot;);
      }

      // 判断委托人是否存在，并判断是否合法委托人
      if (bytes(enrolled_nodes[delegator].id).length == 0) {
        return (false, &quot;delegator is not exsits.&quot;);
      } else if (enroll_node == delegator) {
        return (false, &quot;enroller can not be delegator.&quot;);
      }

      if(check_str_equal(_type, TYPE_MANUFACTURER) &amp;&amp;  check_str_equal(enrolled_nodes[delegator]._type, TYPE_SUPPLIER)) {
        return (false, &quot;not allowed enroll operator&quot;);
      } else if (check_str_equal(_type, TYPE_COVEYANCE) &amp;&amp; check_str_equal(enrolled_nodes[delegator]._type, TYPE_MANUFACTURER)) {
        return (false, &quot;not allowed enroll operator&quot;);
      } else if (check_str_equal(_type, TYPE_RETAIL) &amp;&amp; check_str_equal(enrolled_nodes[delegator]._type,TYPE_COVEYANCE)) {
        return (false, &quot;not allowed enroll operator&quot;);
      }

      // 判断签名是否正确
      address sign_address = ecrecovery(hash, signature);
      if (sign_address != delegator) {
        return (false, &quot;error signature.&quot;);
      }

      // 登记节点
      enrolled_nodes[enroll_node].id = id;
      enrolled_nodes[enroll_node].ip = ip;
      enrolled_nodes[enroll_node].name = name;
      enrolled_nodes[enroll_node].area = area;
      enrolled_nodes[enroll_node]._type = _type;
      enrolled_nodes[enroll_node].nodeType = nodeType;
      enrolled_nodes[enroll_node].productType = productType;
      enrolled_nodes[enroll_node].productAmount = productAmount;
      enrolled_nodes[enroll_node].status = &quot;active&quot;;
      enrolled_nodes[enroll_node].delegatorSignature = signature;
      enrolled_nodes[enroll_node].delegator = delegator;

      used[name] = enroll_node;
      used[ip] = enroll_node;

      return (true, &quot;ok&quot;);
    }

    //登记内部节点，登记的时候需要提交签名和主节点所签名的内容hash，在校验通过之后才会登记成功，并将成功的节点添加到storage中
    function enroll_internal_node(string memory id, string memory ip, string memory name, string memory area,
       string memory _type, string memory nodeType, string memory productType, uint8 productAmount,
       bytes memory signature, bytes32 hash, address delegator) public returns(bool, string memory) {
      address enroll_node = msg.sender;
      //判断属性内容是否都不为空
      //判断id是否已经存在，name是否存在， 判断ip地址是否存在
      if(check_str_equal(id, &quot;&quot;) || check_str_equal(ip, &quot;&quot;) || check_str_equal(name, &quot;&quot;) ||
        check_str_equal(area, &quot;&quot;) || check_str_equal(_type, &quot;&quot;) || check_str_equal(nodeType, &quot;&quot;)) {
        return (false, &quot;parameters empty error&quot;);
      }

      if (used[name] != address(0x0)) {
        return (false, &quot;name is used&quot;);
      }
      if (used[ip] != address(0x0)) {
        return (false, &quot;ip is used&quot;);
      }

      // 判断委托人是否存在，并判断是否合法委托人
      if (bytes(enrolled_nodes[delegator].id).length == 0) {
        return (false, &quot;delegator is not exsits.&quot;);
      } else if (enroll_node == delegator) {
        return (false, &quot;enroller can not be delegator.&quot;);
      } else if(!check_str_equal(_type, enrolled_nodes[delegator]._type)) {
        return (false, &quot;delgator does not have the permission.&quot;);
      }

      // 判断签名是否正确
      address sign_address = ecrecovery(hash, signature);
      if (sign_address != delegator) {
        return (false, &quot;error signature.&quot;);
      }

      // 登记节点
      enrolled_nodes[enroll_node].id = id;
      enrolled_nodes[enroll_node].ip = ip;
      enrolled_nodes[enroll_node].name = name;
      enrolled_nodes[enroll_node].area = area;
      enrolled_nodes[enroll_node]._type = _type;
      enrolled_nodes[enroll_node].nodeType = nodeType;
      enrolled_nodes[enroll_node].productType = productType;
      enrolled_nodes[enroll_node].productAmount = productAmount;
      enrolled_nodes[enroll_node].status = &quot;active&quot;;
      enrolled_nodes[enroll_node].delegatorSignature = signature;
      enrolled_nodes[enroll_node].delegator = delegator;

      used[name] = enroll_node;
      used[ip] = enroll_node;

      return (true, &quot;ok&quot;);
    }

    function  get_node() public returns (string memory id, string memory name, string memory ip) {
      address sender = msg.sender;
      Node memory node = enrolled_nodes[sender];
      return (node.id, node.name, node.ip);
    }

    function write_iiot_information(string info, string policy, bytes signature, bytes32 hash) public returns (string) {
        address sender = msg.sender;
        // 如果是未成功登记的节点，无法进行数据写入，直接返回错误信息
        if (bytes(enrolled_nodes[sender].id).length == 0) {
          return &quot;forbidden operator because of unkown node.&quot;;
        }
        address sign_address = ecrecovery(hash, signature);
        if (sign_address == sender) {
            infos[infos.length++] = info;
            info_lists[sender].push(info);
            policy_storage[sender] = policy;
        } else {
            return &quot;fail because of sinature not right.&quot;;
        }
        return policy_storage[sender];
    }

    function get_iiot_information_length() public returns (uint) {
        address sender = msg.sender;
        string[] x = info_lists[sender];
        return x.length;
    }

    //获取iiot设备写入的信息内容
    function read_iiot_infomation_list(uint index) public returns (string){
        address sender = msg.sender;
        string[] x = info_lists[sender];
        if (x.length &gt; 0 &amp;&amp; index &lt; x.length) {
            return x[index];
        }
        return &quot;no information till now&quot;;
    }

    //读取iiot写入到区块链的访问策略
    function read_iiot_policy_storage() public view returns (string){
        return policy_storage[msg.sender];
    }

    //内部方法，判断两个字符串是否相等
    function check_str_equal(string memory str1, string memory str2) internal returns (bool) {
      if(keccak256(abi.encodePacked(str1)) == keccak256(abi.encodePacked(str2))) {
        return true;
      }
      return false;
    }

    //通过方法登记节点，由于以太坊对本地变量的限制，点用此方法有可能会出现栈溢出问题
    function make_node(address node, string memory id, string memory ip, string memory name,
        string memory area, string memory _type, string memory nodeType, string memory productType,
        uint8 productAmount, string memory status, bytes memory signature, address delegator) internal {
      enrolled_nodes[node].id = id;
      enrolled_nodes[node].ip = ip;
      enrolled_nodes[node].name = name;
      enrolled_nodes[node].area = area;
      enrolled_nodes[node]._type = _type;
      enrolled_nodes[node].nodeType = nodeType;
      enrolled_nodes[node].productType = productType;
      enrolled_nodes[node].productAmount = productAmount;
      enrolled_nodes[node].status = status;
      enrolled_nodes[node].delegatorSignature = signature;
      enrolled_nodes[node].delegator = delegator;

      used[name] = node;
      used[ip] = node;
    }
    //校验签名是否正确
    function ecrecovery(bytes32 hash, bytes memory sig) internal returns (address) {
      bytes32 r;
      bytes32 s;
      uint8 v;

      if (sig.length != 65) {
        return address(0x0);
      }

      assembly {
        r := mload(add(sig, 32))
        s := mload(add(sig, 64))
        v := and(mload(add(sig, 65)), 255)
      }

      if (v &lt; 27) {
        v += 27;
      }

      if (v != 27 &amp;&amp; v != 28) {
        return address(0x0);
      }
      bytes memory prefix = &quot;\x19Ethereum Signed Message:\n32&quot;;
      hash = sha3(prefix, hash);
      return ecrecover(hash, v, r, s);
    }
}
</code></pre><h2 id="启动以太坊网络"><a href="#启动以太坊网络" class="headerlink" title="启动以太坊网络"></a>启动以太坊网络</h2><p>本实验环境基于 Ubuntu 16.04 系统，以太坊相关软件版本为：</p>
<pre><code>nodejs   v10.13.0
npm      6.5.0
geth     1.8.20-stable
Truffle  v4.1.15 (core: 4.1.15)
Solidity v0.4.25 (solc-js)
web3     1.x
testrpc v6.0.3 (ganache-core: 2.0.2)
</code></pre><p>具体安装查看本专栏其他博客内容。</p>
<p>启动以太坊网络</p>
<pre><code>testrpc
</code></pre><p><img src="/images/blockchain/ethereum/iiot/start-net.png" alt=""></p>
<p>打开网页版本<code>remix</code>：<a href="http://remix.ethereum.org/，使用这个插件的好处是可以任意选择编译器，这里选择的编译器是`0.4.25+commit.59dbf8f1.Emscripten.clang`，项目结构如下" target="_blank" rel="noopener">http://remix.ethereum.org/，使用这个插件的好处是可以任意选择编译器，这里选择的编译器是`0.4.25+commit.59dbf8f1.Emscripten.clang`，项目结构如下</a><br><img src="/images/blockchain/ethereum/iiot/remix-web.png" alt=""></p>
<h2 id="编译代码"><a href="#编译代码" class="headerlink" title="编译代码"></a>编译代码</h2><p>首先使用remix-web进行代码编译，之后选择<code>Run</code>模块，选择<code>Web3 Provider</code>之后确定为本地环境即可，然后部署代码到本地环境。</p>
<p>由于之后使用web3js的client时，需要用到智能合约编译的abi以及地址，则使用truffle工具进行abi编译</p>
<pre><code>mkdir Iiot &amp;&amp; cd Iiot
truffle init
</code></pre><p>进入到目录之后，新建代码文件<code>Iiot.sol</code>，将代码复制进去，如下<br><img src="/images/blockchain/ethereum/iiot/atom-truffle.png" alt=""></p>
<p>编译代码</p>
<pre><code>truffle compile
</code></pre><p>会生成<code>build</code>目录，其中会有<code>Iiot.json</code>，其中内容包含了abi</p>
<h2 id="编写测试代码，模拟IIOT环境"><a href="#编写测试代码，模拟IIOT环境" class="headerlink" title="编写测试代码，模拟IIOT环境"></a>编写测试代码，模拟IIOT环境</h2><h3 id="管理员账户签名"><a href="#管理员账户签名" class="headerlink" title="管理员账户签名"></a>管理员账户签名</h3><pre><code>node admin_sign.js

待签名信息: blockchain0xa16ec2786de743e0c3b0fefb3fc7319470535f72
对信息进行hash处理得到shaMsg: 0xe0cf2a7b5f7efc14ebe44d494412788e3c1ffc6212f6ea4e2fbe5ce15e3aa427
账户 0x958814062fda3ab677acf373196935e539e61131 对信息进行签名得到signedData: 0x7a339f232d6d1674d9fe0389a54398f7db670312d62fffbcb95cd1576dbb2f6d629c1aa6f457548d99856d1edcf74bfff27de50952c60d764c03665b492aa0d501
</code></pre><p>实验中，所有节点都是对单词<code>blockchain</code>加上需要签名的节点的地址的内容进行hash，然后对hash值进行签名，使用的是以太坊生成的私钥进行签名。</p>
<h3 id="supplier供应商"><a href="#supplier供应商" class="headerlink" title="supplier供应商"></a>supplier供应商</h3><h4 id="登记节点"><a href="#登记节点" class="headerlink" title="登记节点"></a>登记节点</h4><p>因为供应商的角色比较高，因此其需要泗洪管理员admin的签名进行登记，如果不是管理的签名则登记失败。<br>登记的客户端代码如下所示</p>
<pre><code>var delegator_account = &quot;0x958814062fda3ab677acf373196935e539e61131&quot;; //授权者，也就是admin
var signature = &quot;0x330fbb0e43046efb4de67719f8d93ca67a6ad8cda093e368143c2c9267b2b677683bfd4115cc70c32a1f949b06c773904e2e7ed01c99efc3d8220af27f5fce0f01&quot;;  //admin为供应商签好的名
var hash = &quot;0x7ee156df5091fbef71b96557542210a9c9ca851cc85aaf60026519b4aaccf491&quot;;

iiot_contract.methods
.enroll_manager_node(&quot;CH01&quot;, &quot;192.168.0.2&quot;, &quot;suppiler01&quot;, &quot;guangdong&quot;, &quot;供应商&quot;, &quot;主节点&quot;, &quot;水果&quot;, 100, signature, hash, delegator_account)
.call({from: supplier, gas: 300000}).then(function(result){
    console.log(result);
});
</code></pre><p>对应到合约方法</p>
<pre><code>//登记节点，登记的时候需要提交签名和所签名的内容hash，在校验通过之后才会登记成功，并将成功的节点添加到storage中
function enroll_manager_node(string memory id, string memory ip, string memory name, string memory area,
    string memory _type, string memory nodeType, string memory productType, uint8 productAmount,
    bytes memory signature, bytes32 hash, address delegator) public returns(bool, string memory);
</code></pre><p>执行结果如下<br><img src="/images/blockchain/ethereum/iiot/supplier_enroll.png" alt=""></p>
<h4 id="获取自己节点信息以及为自己的节点签名登记"><a href="#获取自己节点信息以及为自己的节点签名登记" class="headerlink" title="获取自己节点信息以及为自己的节点签名登记"></a>获取自己节点信息以及为自己的节点签名登记</h4><p>suppiler可以通过调用合约方法获得自己的信息，内容在脚本代码<code>supplier_get_node_info.js</code>中，执行结果如下<br><img src="/images/blockchain/ethereum/iiot/supplier_op.png" alt=""></p>
<h4 id="读写IIOT产生的数据"><a href="#读写IIOT产生的数据" class="headerlink" title="读写IIOT产生的数据"></a>读写IIOT产生的数据</h4><p>suppiler的节点产生数据之后需要写入数据到区块链中，执行结果如下<br><img src="/images/blockchain/ethereum/iiot/supplier_read_write.png" alt=""></p>
<h4 id="签名不正确无法执行写入操作"><a href="#签名不正确无法执行写入操作" class="headerlink" title="签名不正确无法执行写入操作"></a>签名不正确无法执行写入操作</h4><p>由于签名不正确,则无法写入数据到区块链<br><img src="/images/blockchain/ethereum/iiot/write_fail.png" alt=""></p>
<h3 id="supplier-internal-node"><a href="#supplier-internal-node" class="headerlink" title="supplier-internal-node"></a>supplier-internal-node</h3><h4 id="登记内部节点成功"><a href="#登记内部节点成功" class="headerlink" title="登记内部节点成功"></a>登记内部节点成功</h4><pre><code>bash-3.2$ node supplier_enroll_internal_node.js 
Result { &#39;0&#39;: true, &#39;1&#39;: &#39;ok&#39; }
{ id: &#39;CH03&#39;,
  ip: &#39;192.168.0.3&#39;,
  name: &#39;suppiler-child-01&#39;,
  area: &#39;guangdong&#39;,
  _type: &#39;供应商&#39;,
  nodeType: &#39;子节点&#39;,
  productType: &#39;水果&#39;,
  productAmount: 100,
  signature:
   &#39;0x9bff0f16ea43200dc3623fece41538fa7193ea24c199b1fae42ef2f17aafade6737e2b5299618453fee737a8f9990e987a2d759eee1569745766cd804b4d6cc101&#39;,
  hash:
   &#39;0x7ee156df5091fbef71b96557542210a9c9ca851cc85aaf60026519b4aaccf491&#39;,
  delegator: &#39;0x8215e1a386ea33470c51017bb21501c33bab85fc&#39; 
}
bash-3.2$ 
</code></pre><h4 id="登记内部节点失败"><a href="#登记内部节点失败" class="headerlink" title="登记内部节点失败"></a>登记内部节点失败</h4><p>如果用了非法的签名或者对应的委托人不存在，则登记会失败</p>
<pre><code>bash-3.2$ node supplier_enroll_internal_node.js 
Result { &#39;0&#39;: false, &#39;1&#39;: &#39;delegator is not exsits.&#39; }
{ id: &#39;CH03&#39;,
  ip: &#39;192.168.0.3&#39;,
  name: &#39;suppiler-child-01&#39;,
  area: &#39;guangdong&#39;,
  _type: &#39;供应商&#39;,
  nodeType: &#39;子节点&#39;,
  productType: &#39;水果&#39;,
  productAmount: 100,
  signature:
   &#39;0x9bff0f16ea43200dc3623fece41538fa7193ea24c199b1fae42ef2f17aafade6737e2b5299618453fee737a8f9990e987a2d759eee1569745766cd804b4d6cc101&#39;,
  hash:
   &#39;0x7ee156df5091fbef71b96557542210a9c9ca851cc85aaf60026519b4aaccf491&#39;,
  delegator: &#39;0x9ea1247cf93f7a2982e126df62c99d5028dea81f&#39; 
}
bash-3.2$ 
</code></pre><h4 id="内部节点获取节点信息"><a href="#内部节点获取节点信息" class="headerlink" title="内部节点获取节点信息"></a>内部节点获取节点信息</h4><pre><code>bash-3.2$ node supplier_internal_get_node_info.js 

return node information: node_id: CH03, node_ip: 192.168.0.66, node_name = suppiler-child-04
</code></pre><h4 id="内部节点读写IIOT数据"><a href="#内部节点读写IIOT数据" class="headerlink" title="内部节点读写IIOT数据"></a>内部节点读写IIOT数据</h4><pre><code>bash-3.2$ node supplier_internal_node_write_information.js 


result: suppiler or manufacturer or admin
iiot node suppiler write information, info: iiot node: weight: 15kg, color: red, height: 10cm,..., policy: suppiler or manufacturer or admin, signature: 0x1ad5d6778d9e1d9f79dfb40fd0f7ca5e194e91ed63e476ab5f91b59eb6a9e3760526b45c09d8409709b91f15518d12d94f6b68d0614fbb20a596ff38fd56858300, hash: 0x7ee156df5091fbef71b96557542210a9c9ca851cc85aaf60026519b4aaccf491
</code></pre><h4 id="读写失败"><a href="#读写失败" class="headerlink" title="读写失败"></a>读写失败</h4><p>如果是没有登记成功的节点，进行写入区块链会返回非法操作的错误</p>
<pre><code>bash-3.2$ node supplier_internal_node_read_write.js 

result: forbidden operator because of unkown node.
iiot internal node suppiler write information, info: iiot internal node: weight: 15kg, color: red, height: 10cm,..., policy: suppiler or manufacturer or admin, signature: 0x9bff0f16ea43200dc3623fece41538fa7193ea24c199b1fae42ef2f17aafade6737e2b5299618453fee737a8f9990e987a2d759eee1569745766cd804b4d6cc101, hash: 0x7ee156df5091fbef71b96557542210a9c9ca851cc85aaf60026519b4aaccf491
</code></pre><p><img src="/images/blockchain/ethereum/iiot/internal_node_op.png" alt=""></p>
<h3 id="其余节点"><a href="#其余节点" class="headerlink" title="其余节点"></a>其余节点</h3><p>其余节点的登记于操作和供应商类似，其中权限都在智能合约中控制，不再赘述。</p>
<h2 id="仿真平台概况"><a href="#仿真平台概况" class="headerlink" title="仿真平台概况"></a>仿真平台概况</h2><h3 id="开发语言"><a href="#开发语言" class="headerlink" title="开发语言"></a>开发语言</h3><ul>
<li>JavaScript<ul>
<li>用于开发<code>node-client</code></li>
</ul>
</li>
<li>Solidity<ul>
<li>用于开发智能合约</li>
<li>版本0.4.15</li>
<li>简介: Solidity is an object-oriented, high-level language for implementing smart contracts. Smart contracts are programs which govern the behaviour of accounts within the Ethereum state.</li>
</ul>
</li>
<li>Shell<ul>
<li>用于实现node-client与智能合约的交互</li>
<li>控制不同节点的输入输出</li>
</ul>
</li>
</ul>
<h3 id="开发环境"><a href="#开发环境" class="headerlink" title="开发环境"></a>开发环境</h3><p>操作系统: Ubuntu 16.04<br>软件环境</p>
<pre><code>nodejs   v10.13.0
npm      6.5.0
geth     1.8.20-stable
Truffle  v4.1.15 (core: 4.1.15)
Solidity v0.4.25 (solc-js)
web3     1.x
testrpc v6.0.3 (ganache-core: 2.0.2)
</code></pre><h3 id="使用到的api"><a href="#使用到的api" class="headerlink" title="使用到的api"></a>使用到的api</h3><p>1. web3.eth.sign<br>web3.eth.sign()方法使用指定的账户对数据进行签名，该账户必须先解锁。<br>调用：</p>
<pre><code>web3.eth.sign(dataToSign, address [, callback])
</code></pre><p>参数：</p>
<ul>
<li>dataToSign：String - 待签名的数据。对于字符串将首先使用web3.utils.utf8ToHex()方法将其转换为16进制</li>
<li>address：String|Number - 用来签名的账户地址。或者本地钱包web3.eth.accounts.wallet中的地址或其序号</li>
<li>callback：Function - 可选的回调函数，其第一个参数为错误对象，第二个参数为结果</li>
</ul>
<p>2. myContract.methods.myMethod().call()<br>call - 调用合约方法<br>调用合约的只读方法，并在EVM中直接执行方法，不需要发送任何交易。因此不会改变合约的状态。<br>调用：</p>
<pre><code>myContract.methods.myMethod([param1[, param2[, ...]]]).call(options[, callback])
</code></pre><p>参数：</p>
<ul>
<li>options - Object : 选项，包含如下字段：<br>from - String (optional): The address the call “transaction” should be made from.<br>gasPrice - String (optional): The gas price in wei to use for this call “transaction”.<br>gas - Number (optional): The maximum gas provided for this call “transaction” (gas limit).</li>
<li>callback - Function : 可选的回调函数，其第二个参数为合约方法的执行结果，第一个参数为错误对象</li>
</ul>
<p>3. myContract.methods.myMethod().send()<br>向合约发送交易来执行指定方法，将改变合约的状态。<br>调用：</p>
<pre><code>myContract.methods.myMethod([param1[, param2[, ...]]]).send(options[, callback])
</code></pre><p>参数：</p>
<ul>
<li>options - Object: 选项，包含如下字段：<br>from - String: 交易发送方地址<br>gasPrice - String : 可选，用于本次交易的gas价格，单位：wei<br>gas - Number : 可选，本次交易的gas用量上限，即gas limit<br>value - Number|String|BN|BigNumber: 可选，交易转账金额，单位：wei</li>
<li>callback - Function: 可选的回调参数，其参数为交易哈希值和错误对象</li>
</ul>
<p>4. web3.utils.sha3<br>使用web3.utils.sha3()方法计算给定字符串的sha3哈希值。</p>
<p>注意，如果要模拟solidity中的sha3，请使用soliditySha3函数。</p>
<p>调用：</p>
<pre><code>web3.utils.sha3(string)
web3.utils.keccak256(string) // ALIAS
</code></pre><p>参数：</p>
<ul>
<li>string - String: 要计算sha3哈希值的字符串</li>
</ul>
<p>返回值：</p>
<ul>
<li>String: 计算结果哈希值</li>
</ul>
<h3 id="CP-ABE"><a href="#CP-ABE" class="headerlink" title="CP-ABE"></a>CP-ABE</h3><p>由于时间关系，CP-ABE算法没有引入。</p>

                

                <hr>
                <!-- Pager -->
                <ul class="pager">
                    
                        <li class="previous">
                            <a href="/2019/01/24/docker/docker-mysql-adminer/" data-toggle="tooltip" data-placement="top" title="Docker 安装 Mysql + Adminer">&larr; Previous Post</a>
                        </li>
                    
                    
                        <li class="next">
                            <a href="/2019/01/12/blockchain/ethereum/ethereum-installation/" data-toggle="tooltip" data-placement="top" title="以太坊开发环境搭建">Next Post &rarr;</a>
                        </li>
                    
                </ul>

                <!-- duoshuo Share start -->
                
                <!-- 多说 Share end-->

                <!-- 多说评论框 start -->
                
                <!-- 多说评论框 end -->

                <!-- disqus comment start -->
                
                    <div class="comment">
                        <div id="disqus_thread" class="disqus-thread"></div>
                    </div>
                
                <!-- disqus comment end -->
            </div>
            
            <!-- Tabe of Content -->
            <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-1"><a class="toc-nav-link" href="#使用以太坊进行IIOT实验"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">使用以太坊进行IIOT实验</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#编写智能合约"><span class="toc-nav-number">1.1.</span> <span class="toc-nav-text">编写智能合约</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#启动以太坊网络"><span class="toc-nav-number">1.2.</span> <span class="toc-nav-text">启动以太坊网络</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#编译代码"><span class="toc-nav-number">1.3.</span> <span class="toc-nav-text">编译代码</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#编写测试代码，模拟IIOT环境"><span class="toc-nav-number">1.4.</span> <span class="toc-nav-text">编写测试代码，模拟IIOT环境</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#管理员账户签名"><span class="toc-nav-number">1.4.1.</span> <span class="toc-nav-text">管理员账户签名</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#supplier供应商"><span class="toc-nav-number">1.4.2.</span> <span class="toc-nav-text">supplier供应商</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#登记节点"><span class="toc-nav-number">1.4.2.1.</span> <span class="toc-nav-text">登记节点</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#获取自己节点信息以及为自己的节点签名登记"><span class="toc-nav-number">1.4.2.2.</span> <span class="toc-nav-text">获取自己节点信息以及为自己的节点签名登记</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#读写IIOT产生的数据"><span class="toc-nav-number">1.4.2.3.</span> <span class="toc-nav-text">读写IIOT产生的数据</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#签名不正确无法执行写入操作"><span class="toc-nav-number">1.4.2.4.</span> <span class="toc-nav-text">签名不正确无法执行写入操作</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#supplier-internal-node"><span class="toc-nav-number">1.4.3.</span> <span class="toc-nav-text">supplier-internal-node</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#登记内部节点成功"><span class="toc-nav-number">1.4.3.1.</span> <span class="toc-nav-text">登记内部节点成功</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#登记内部节点失败"><span class="toc-nav-number">1.4.3.2.</span> <span class="toc-nav-text">登记内部节点失败</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#内部节点获取节点信息"><span class="toc-nav-number">1.4.3.3.</span> <span class="toc-nav-text">内部节点获取节点信息</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#内部节点读写IIOT数据"><span class="toc-nav-number">1.4.3.4.</span> <span class="toc-nav-text">内部节点读写IIOT数据</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#读写失败"><span class="toc-nav-number">1.4.3.5.</span> <span class="toc-nav-text">读写失败</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#其余节点"><span class="toc-nav-number">1.4.4.</span> <span class="toc-nav-text">其余节点</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#仿真平台概况"><span class="toc-nav-number">1.5.</span> <span class="toc-nav-text">仿真平台概况</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#开发语言"><span class="toc-nav-number">1.5.1.</span> <span class="toc-nav-text">开发语言</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#开发环境"><span class="toc-nav-number">1.5.2.</span> <span class="toc-nav-text">开发环境</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#使用到的api"><span class="toc-nav-number">1.5.3.</span> <span class="toc-nav-text">使用到的api</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#CP-ABE"><span class="toc-nav-number">1.5.4.</span> <span class="toc-nav-text">CP-ABE</span></a></li></ol></li></ol></li></ol>
        
        </div>
      </aside>
    

                
            <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                
                <section>
                    <!-- no hr -->
                    <h5><a href="/tags/">FEATURED TAGS</a></h5>
                    <div class="tags">
                       
                          <a class="tag" href="/tags/#Blockchain" title="Blockchain">Blockchain</a>
                        
                          <a class="tag" href="/tags/#Ethereum" title="Ethereum">Ethereum</a>
                        
                    </div>
                </section>
                

                <!-- Friends Blog -->
                
                <hr>
                <h5>FRIENDS</h5>
                <ul class="list-inline">

                    
                        <li><a href="https://www.lookfor404.com/" target="_blank">lookfor404</a></li>
                    
                        <li><a href="https://silence-linhl.github.io/blog/" target="_blank">silence</a></li>
                    
                        <li><a href="https://yisiychan.github.io/" target="_blank">yisiychan</a></li>
                    
                        <li><a href="https://b3434lock.gitee.io/" target="_blank">b3434lock</a></li>
                    
                        <li><a href="http://lamyoung.com/" target="_blank">lamyoung</a></li>
                    
                </ul>
                
            </div>
        </div>
    </div>
</article>




<!-- disqus embedded js code start (one page only need to embed once) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "banbanblog";
    var disqus_identifier = "https://banbanpeppa.github.io/2019/01/13/blockchain/ethereum/iiot-experiment/";
    var disqus_url = "https://banbanpeppa.github.io/2019/01/13/blockchain/ethereum/iiot-experiment/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus embedded js code start end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'left',
          icon: 'ℬ'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                
                    <li>
                        <a href="/atom.xml">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://twitter.com/ZhilingSomnus">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                
                
                    <li>
                        <a target="_blank" href="https://www.zhihu.com/people/banbanpeppa">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa  fa-stack-1x fa-inverse">知</i>
                            </span>
                        </a>
                    </li>
                

                
                    <li>
                        <a target="_blank" href="http://weibo.com/3112637187">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-weibo fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                
                    <li>
                        <a target="_blank" href="https://github.com/banbanpeppa">
                            <span class="fa-stack fa-lg">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
                

                

                </ul>
                <p class="copyright text-muted">
                    Copyright &copy; Chen Zhi Ling 2020
                    <br>
                    <!-- Theme by <a href="http://huangxuan.me">Hux</a>
                    <span style="display: inline-block; margin: 0 5px;">
                        <i class="fa fa-heart"></i>
                    </span>
                    re-Ported by <a href="http://beantech.org">BeanTech</a> |
                    <iframe
                        style="margin-left: 2px; margin-bottom:-5px;"
                        frameborder="0" scrolling="0" width="91px" height="20px"
                        src="https://ghbtns.com/github-btn.html?user=banbanpeppa&repo=hexo-theme-beantech&type=star&count=true" >
                    </iframe> -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js"></script>

<!-- Bootstrap Core JavaScript -->
<script src="/js/bootstrap.min.js"></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js"></script>


<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>

<!-- jquery.tagcloud.js -->
<script>
    // only load tagcloud.js in tag.html
    if($('#tag_cloud').length !== 0){
        async("https://banbanpeppa.github.io/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                //size: {start: 1, end: 1, unit: 'em'},
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>

<!--fastClick.js -->
<script>
    async("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->




<!-- Baidu Tongji -->



<!-- Highlight.js -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-dark.min.css">
<script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
<script>
    hljs.initHighlightingOnLoad();
</script>




	<a id="rocket" href="#top" class=""></a>
	<script type="text/javascript" src="/js/totop.js?v=1.0.0" async=""></script>
    <script type="text/javascript" src="/js/toc.js?v=1.0.0" async=""></script>
<!-- Image to hack wechat -->
<img src="https://banbanpeppa.github.io/images/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
